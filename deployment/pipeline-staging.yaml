trigger:
  batch: true
  branches:
    include:
    - staging
  paths:
    exclude:
    -  docs/*
pr: none
resources:
  - repo: self

variables:
  # ========================================================================
  #                          Mandatory variables 
  # ========================================================================
  Docker.backend.filePath: "**/backend/Dockerfile"
  Docker.frontend.filePath: "**/frontend/Dockerfile"
  Docker.airflow.filePath: "**/airflow/Dockerfile"
  Docker.backend.repository: "hope-backend"
  Docker.frontend.repository: "hope-frontend"
  Docker.airflow.repository: "hope-airflow"
  Docker.registry: "uniappsk8sdevacr"
  Kubernetes.serviceConnection: "ICTD-HOPE-STG-uni-apps-aks-dev-ictd-hope-stg-1602346345867"
  Kubernetes.namespace: "ictd-hope-stg"

stages:
  - stage: build_and_push
    displayName: BUILD and PUSH
    jobs:
      - job: build_push_backend
        displayName: "[BACKEND]"
        steps:
          - task: Docker@2
            displayName: Build&Push
            inputs:
              command: buildAndPush
              dockerfile: $(Docker.backend.filePath)
              repository: $(Docker.backend.repository)
              containerRegistry: $(Docker.registry)
              tags: |
                $(Build.BuildId)
                dev-latest

      - job: build_push_airflow
        displayName: "[AIRFLOW]"
        steps:
          - task: Docker@2
            displayName: Build&Push
            inputs:
              command: buildAndPush
              dockerfile: $(Docker.airflow.filePath)
              repository: $(Docker.airflow.repository)
              containerRegistry: $(Docker.registry)
              buildContext: "$(Build.SourcesDirectory)"
              tags: |
                $(Build.BuildId)
                dev-latest

      - job: build_push_frontend
        displayName: "[FRONTEND]"
        steps:
          - task: Docker@2
            displayName: Build
            inputs:
              command: build
              dockerfile: $(Docker.frontend.filePath)
              repository: $(Docker.frontend.repository)
              arguments: --build-arg SENTRY_FRONTEND_DSN=$(SENTRY_FRONTEND_DSN)
              containerRegistry: $(Docker.registry)
              tags: |
                $(Build.BuildId)
                dev-latest
          - task: Docker@2
            displayName: Push
            inputs:
              command: push
              dockerfile: $(Docker.frontend.filePath)
              repository: $(Docker.frontend.repository)
              containerRegistry: $(Docker.registry)
              tags: |
                $(Build.BuildId)
                dev-latest

  - stage: deploy
    displayName: DEPLOY
    jobs:
      - job: deploy_hope
        displayName: "[HOPE]"
        steps:
          - task: HelmDeploy@0
            displayName: "[HOPE] Update Chart dependencies"
            inputs:
              connectionType: 'Kubernetes Service Connection'
              kubernetesServiceConnection: $(Kubernetes.serviceConnection)     
              command: package
              updatedependency: true
              chartPath: '**/deployment/hope'
          - task: HelmDeploy@0
            displayName: "[HOPE] DEPLOY"
            inputs:
              connectionType: 'Kubernetes Service Connection'
              kubernetesServiceConnection: $(Kubernetes.serviceConnection)
              namespace: $(Kubernetes.namespace)
              command: 'upgrade'
              chartType: 'FilePath'
              chartPath: '**/deployment/hope'
              releaseName: 'hope'
              install: true
              waitForExecution: false
              failOnStderr: false
              arguments: "--timeout 600s"
              valueFile: '**/deployment/azure-stg-values.yaml'
              overrideValues: "
                global.env=staging,\
                global.storageClass=default,\
                global.init=false,\
                backend.image=uniappsk8sdevacr.azurecr.io/$(Docker.backend.repository):$(Build.BuildId),\
                backend.config.STORAGE_AZURE_ACCOUNT_NAME=$(STORAGE_AZURE_ACCOUNT_NAME),\
                backend.config.AZURE_CLIENT_ID=$(AZURE_CLIENT_ID),\
                backend.config.POSTGRES_SSL='true',\
                backend.secret.SECRET_KEY=$(SECRET_KEY),\
                backend.secret.STORAGE_AZURE_ACCOUNT_KEY=$(STORAGE_AZURE_ACCOUNT_KEY),\
                backend.secret.AZURE_CLIENT_SECRET=$(AZURE_CLIENT_SECRET),\
                backend.secret.AZURE_TENANT_KEY=$(AZURE_TENANT_KEY),\
                backend.secret.SENTRY_DSN=$(SENTRY_DSN),\
                backend.secret.EMAIL_HOST=$(EMAIL_HOST),\
                backend.secret.KOBO_API_URL=$(KOBO_API_URL),\
                backend.secret.KOBO_MASTER_API_TOKEN=$(KOBO_MASTER_API_TOKEN),\
                frontend.secret.DATAMART_USER=$(DATAMART_USER),\
                frontend.secret.DATAMART_PASSWORD=$(DATAMART_PASSWORD),\
                frontend.secret.DATAMART_URL=$(DATAMART_URL),\
                frontend.secret.SENTRY_FRONTEND_DSN=$(SENTRY_FRONTEND_DSN),\
                frontend.image=uniappsk8sdevacr.azurecr.io/$(Docker.frontend.repository):$(Build.BuildId),\
                ingress.host=stg-hope.unitst.org,\
                ingress.tls=true,\
                airflow.baseUrl=stg-hope.unitst.org/airflow,\
                airflow.airflow.baseUrl=stg-hope.unitst.org/airflow,\
                airflow.airflow.image.repository=uniappsk8sdevacr.azurecr.io/$(Docker.airflow.repository),\
                airflow.airflow.image.tag=$(Build.BuildId),\
                airflow.ingress.hosts.0.name=airflow-hope-stg.unitst.org,\
                airflow.ingress.hosts.0.tls=true,\
                airflow.ingress.hosts.0.path=/,\
                airflow.ingress.hosts.0.tlsSecret=aks-unitst-tls,\
                postgresql.enabled=false,\
                postgresql.postgresqlPassword=$(POSTGRES_PASSWORD),\
                postgresql.externalDatabase.host=$(POSTGRES_HOST),\
                postgresql.externalDatabase.user=$(POSTGRES_USER),\
                postgresql.externalDatabase.password=$(POSTGRES_PASSWORD),\
                postgresql.externalDatabase.db=$(POSTGRES_DB),\
                postgresql.externalDatabase.airflowName=$(POSTGRES_DB),\
                registrationdatahubpostgresql.enabled=false,\
                registrationdatahubpostgresql.externalDatabase.host=$(REGISTRATION_DATAHUB_POSTGRES_HOST),\
                registrationdatahubpostgresql.externalDatabase.user=$(REGISTRATION_DATAHUB_POSTGRES_USER),\
                registrationdatahubpostgresql.externalDatabase.password=$(REGISTRATION_DATAHUB_POSTGRES_PASSWORD),\
                registrationdatahubpostgresql.externalDatabase.db=$(REGISTRATION_DATAHUB_POSTGRES_DB),\
                cashassistdatahubpostgresql.enabled=false,\
                cashassistdatahubpostgresql.externalDatabase.host=$(CASH_ASSIST_DATAHUB_POSTGRES_HOST),\
                cashassistdatahubpostgresql.externalDatabase.user=$(CASH_ASSIST_DATAHUB_POSTGRES_USER),\
                cashassistdatahubpostgresql.externalDatabase.password=$(CASH_ASSIST_DATAHUB_POSTGRES_PASSWORD),\
                cashassistdatahubpostgresql.externalDatabase.db=$(CASH_ASSIST_DATAHUB_POSTGRES_DB),\
                airflow.externalDatabase.password=$(POSTGRES_PASSWORD),"
