#apiVersion: batch/v1beta1
#kind: CronJob
#metadata:
#  name: kobocat-mongodbsync
#  {{- if .Values.kpi.annotations }}
#  annotations:
#    {{- toYaml .Values.kobocat.annotations | nindent 4 }}
#  {{- end }}
#  labels:
#    app: {{ include "kobo.labels.app" . }}
#    component: kobocat-mongodbsync
#    chart: {{ include "kobo.labels.chart" . }}
#    release: {{ .Release.Name }}
#    heritage: {{ .Release.Service }}
#    {{- if .Values.kobocat.labels }}
#    {{- toYaml .Values.kobocat.labels | nindent 4 }}
#    {{- end }}
#spec:
#  schedule: "*/2 * * * *"
#  
#  concurrencyPolicy: Allow
#  failedJobsHistoryLimit: 0
#  successfulJobsHistoryLimit: 3
#  jobTemplate:
#    metadata:
#      creationTimestamp: null
#    spec:
#      template:
#
#        spec:
#          restartPolicy: Never
#          containers:
#          - name: backend
#            image: {{ .Values.kobocat.image }}
#            args: ["/bin/bash", "-c", 
#            "source /etc/profile.d/runtime_variables_kobocat.source.bash.sh; ./manage.py sync_mongo --remongo"]
#            resources:
#              {{- toYaml .Values.kobocat.resources | nindent 16 }}
#            env:
#              {{- include "kobo.mapenvsecrets" . | indent 14}}
#            envFrom:
#            - configMapRef:
#                name: kobocat-config
#            volumeMounts:
#            - name: static-volume
#              mountPath: /srv/static
#            - name: uwsgi-config
#              mountPath: /srv/src/kobocat/docker/kobocat.ini
#              subPath: uwsgi.ini
#            - name: scripts
#              mountPath: /etc/profile.d/
#            - name: scripts
#              mountPath: /srv/init/
#          volumes:
#          - name: static-volume
#            emptyDir: {}
#          - name: uwsgi-config
#            configMap:
#              name: kobocat-uwsgi-config
#          - name: nginx-conf
#            configMap:
#              name: nginx-kobocat-conf
#          - name: scripts
#            configMap:
#              name: kobocat-scripts
#              defaultMode: 0744
#              items:
#              - key: runtime_variables_kobocat.source.bash
#                path: runtime_variables_kobocat.source.bash.sh
#              - key: wait_for_postgres.bash
#                path: wait_for_postgres.bash
#              - key: wait_for_mongo.bash
#                path: wait_for_mongo.bash
