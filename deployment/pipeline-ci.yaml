trigger:
  batch: true
  branches:
    include:
    - develop
    - staging
    - master
    - ops/*
  paths:
    exclude:
    -  docs/*
pr: none
resources:
  - repo: self

variables:
  # ========================================================================
  #                          Mandatory variables 
  # ========================================================================
  Docker.backend.filePath: "**/backend/Dockerfile"
  Docker.frontend.filePath: "**/frontend/Dockerfile"
  Docker.backend.repository: "hope-backend"
  Docker.frontend.repository: "hope-frontend"
  Docker.registry_trn: "ICTD-HOPE-DEV-ACR"
  ${{ if ne(variables['Build.SourceBranchName'], 'master') }}:
    Docker.registry: "ICTD-HOPE-DEV-ACR"
    Docker.url: "uniappsakshopedev.azurecr.io"
  ${{ if eq(variables['Build.SourceBranchName'], 'master') }}:
    Docker.registry: "ICTD-HOPE-PRD-ACR"
    Docker.url: "uniappsakshope.azurecr.io"
  ${{ if eq(variables['Build.SourceBranchName'], 'develop') }}:
    Sentry.frontend.dsn: $(DEV_SENTRY_FRONTEND_DSN)
  ${{ if eq(variables['Build.SourceBranchName'], 'staging') }}:
    Sentry.frontend.dsn: $(STG_SENTRY_FRONTEND_DSN)
  ${{ if eq(variables['Build.SourceBranchName'], 'master') }}:
    Sentry.frontend.dsn: $(PRD_SENTRY_FRONTEND_DSN)
    Sentry.frontend.trn_dsn: $(TRN_SENTRY_FRONTEND_DSN)
  isTraining: $[eq(variables['Build.SourceBranchName'], 'master')]

stages:
  - stage: test_frontend
    displayName: Test-Frontend
    jobs:
      - job: django_tests
        pool:
          vmImage: ubuntu-latest
        displayName: "[FRONTEND TEST]"
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: "14.x"
            displayName: "Install Node.js"
          - task: Cache@2
            inputs:
              key: $(Build.SourcesDirectory)/frontend/yarn.lock
              path: $(Build.SourcesDirectory)/frontend/node_modules
            displayName: Cache Yarn packages
          - script: yarn
            displayName: "Yarn Install"
            workingDirectory: 'frontend'

          - script: yarn test --watchAll=false
            workingDirectory: 'frontend'
            displayName: "Test"
  - stage: build_and_push
    dependsOn: []
    displayName: BUILD and PUSH
    jobs:
      - job: build_push_backend
        pool:
          vmImage: ubuntu-latest
        displayName: "[BACKEND]"
        steps:
          - task: Docker@2
            inputs:
              containerRegistry: '$(Docker.registry)'
              command: 'login'
          - script: "docker pull $(Docker.url)/$(Docker.backend.repository):latest"
            displayName: Pull latest for layer caching
            continueOnError: true # for first build, no cache
          - task: Docker@2
            displayName: Build
            inputs:
              command: build
              dockerfile: $(Docker.backend.filePath)
              repository: $(Docker.backend.repository)
              arguments: '--cache-from=$(Docker.url)/$(Docker.backend.repository):latest'
              tags: |
                $(Build.BuildId)
                $(Build.SourceVersion)
                latest
          - task: Docker@2
            displayName: Push
            inputs:
              command: push
              dockerfile: $(Docker.backend.filePath)
              repository: $(Docker.backend.repository)
              containerRegistry: $(Docker.registry)
              tags: |
                $(Build.BuildId)
                $(Build.SourceVersion)
                latest

          - task: Docker@2
            displayName: Build&Push
            condition: and(succeeded(), eq(variables.isTraining, true))
            inputs:
              command: buildAndPush
              dockerfile: $(Docker.backend.filePath)
              repository: $(Docker.backend.repository)
              containerRegistry: $(Docker.registry_trn)
              tags: |
                $(Build.BuildId)
                $(Build.SourceVersion)



      - job: build_push_frontend
        pool:
          vmImage: ubuntu-latest
        displayName: "[FRONTEND]"
        steps:
          - task: Docker@2
            inputs:
              containerRegistry: '$(Docker.registry)'
              command: 'login'
          - script: "docker pull $(Docker.url)/$(Docker.frontend.repository)-stage1:latest"
            displayName: Pull latest for layer caching
            continueOnError: true # for first build, no cache
          - task: Docker@2
            displayName: Build Stage 1
            inputs:
              command: build
              dockerfile: $(Docker.frontend.filePath)
              repository: $(Docker.frontend.repository)-stage1
              arguments: "--build-arg SENTRY_FRONTEND_DSN=$(Sentry.frontend.dsn) 
                       --cache-from=$(Docker.url)/$(Docker.frontend.repository)-stage1:latest
                       --target=dev"
              containerRegistry: $(Docker.registry)
              tags: |
                $(Build.BuildId)
                $(Build.SourceVersion)
                latest
          - task: Docker@2
            displayName: Push Stage 1
            inputs:
              command: push
              dockerfile: $(Docker.frontend.filePath)
              repository: $(Docker.frontend.repository)-stage1
              containerRegistry: $(Docker.registry)
              tags: |
                $(Build.BuildId)
                $(Build.SourceVersion)
                latest
          - task: Docker@2
            displayName: Build
            inputs:
              command: build
              dockerfile: $(Docker.frontend.filePath)
              repository: $(Docker.frontend.repository)
              arguments: "--build-arg SENTRY_FRONTEND_DSN=$(Sentry.frontend.dsn) 
                          --cache-from=$(Docker.url)/$(Docker.frontend.repository)-stage1:latest"
              containerRegistry: $(Docker.registry)
              tags: |
                $(Build.BuildId)
                $(Build.SourceVersion)
                latest

          - task: Docker@2
            displayName: Push
            inputs:
              command: push
              dockerfile: $(Docker.frontend.filePath)
              repository: $(Docker.frontend.repository)
              containerRegistry: $(Docker.registry)
              tags: |
                $(Build.BuildId)
                $(Build.SourceVersion)
                latest

          - task: Docker@2
            displayName: Build frontend for TRN
            condition: and(succeeded(), eq(variables.isTraining, true))
            inputs:
              command: build
              dockerfile: $(Docker.frontend.filePath)
              repository: $(Docker.frontend.repository)
              arguments: --build-arg SENTRY_FRONTEND_DSN=$(Sentry.frontend.trn_dsn)
              containerRegistry: $(Docker.registry_trn)
              tags: |
                $(Build.BuildId)-trn
                $(Build.SourceVersion)-trn

          - task: Docker@2
            displayName: Push frontend for TRN
            condition: and(succeeded(), eq(variables.isTraining, true))
            inputs:
              command: push
              dockerfile: $(Docker.frontend.filePath)
              repository: $(Docker.frontend.repository)
              containerRegistry: $(Docker.registry_trn)
              tags: |
                $(Build.BuildId)-trn
                $(Build.SourceVersion)-trn

  - stage: test
    displayName: TEST
    dependsOn: build_and_push
    jobs:
      - job: django_tests
        pool:
          vmImage: ubuntu-latest
        displayName: "[DJANGO TEST]"
        variables:
          backend_image: $(Docker.url)/$(Docker.backend.repository):$(Build.SourceVersion)
        steps:
          - task: Docker@2
            displayName: "[ACR] Login"
            inputs:
              command: login
              containerRegistry: $(Docker.registry)
          - task: DockerCompose@0
            displayName: "Run tests"
            inputs:
              containerregistrytype: 'Azure Container Registry'
              azureContainerRegistry: $(Docker.registry)
              dockerComposeFile: '**/docker-compose.tst.yml'
              action: 'Run a Docker Compose command'
              dockerComposeCommand: 'run backend test'
              dockerComposeFileArgs: |
                backend_image=$(Docker.url)/$(Docker.backend.repository):$(Build.SourceVersion)
          - task: PublishTestResults@2
            displayName: "Publish Test Result"
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '*.xml'
              searchFolder: 'backend/test-results/'
              mergeTestResults: true
              failTaskOnFailedTests: true
              testRunTitle: 'TEST Results'
