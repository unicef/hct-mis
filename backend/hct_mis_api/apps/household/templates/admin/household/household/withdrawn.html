{% extends "admin_extra_urls/action_page.html" %}{% load hope households i18n admin_urls static admin_modify %}
{% block action-content %}
    {% if not allowed %}
        <h1 style="color:red">This Household cannot be withdrawn because some of his members are collectors for others
            households</h1>
    {% elif original.withdrawn %}
        <h1 style="color: red">Warning: Household already withdrawn</h1>
        <h2>Continuing will restore this household and all his members (not the external collectors) and
            will reopen all tickets closed when it was withdrew.
        </h2>
    {% else %}
        <h2>Continuing will withdrawn household and all his members (not the external collectors) and
            will close any ticket related to the household or his members
        </h2>
    {% endif %}

    <form method="post">
        <input type="checkbox" checked="{{ status }}" disabled="disabled">
        {{ original }}
        <table>
            <tr>
                <td colspan="3">Members</td>
            </tr>
            <tr>
                <th></th>
                <th colspan="3">individual</th>
                <th>is withdrawn</th>
                <th>is duplicate</th>
                <td></td>
            </tr>
            {% for member in original.individuals.all %}
                {% get_extra_roles member as extra_roles %}
                <tr>
                    <td tyle="display: none">
                        {% if extra_roles %}
                        {% else %}
                            <input type="checkbox" checked="{{ status }}" disabled="disabled">
                        {% endif %}
                    </td>

                    <td>
                        <a target="_blank" href="{% url "admin:household_individual_change" member.pk %}">
                            {{ member }}</a>
                    </td>
                    <td>{{ member.full_name }}</td>
                    <td>{{ member.relationship }}</td>
                    <td>
                        <img src="{{ member.withdrawn|bool_to_icon }}">
                    </td>
                    <td>
                        <img src="{{ member.duplicate|bool_to_icon }}">
                    </td>
                    <td>{% if extra_roles %}
                        <div>This Individual is collector for:</div>
                        {% for role in extra_roles %}
                            <a target="_blank" href="{% url "admin:household_household_change" role.household.pk %}">
                                {{ role.household }}</a>
                            <a target="_blank"
                               href="{% url "admin:household_individualroleinhousehold_change" role.pk %}">
                                ({{ role.role }})</a>
                        {% endfor %}
                    {% endif %}
                    </td>
                </tr>
            {% endfor %}
            <tr>
                <td colspan="3">Collectors</td>
            </tr>
            {% for collector in original.individuals_and_roles.all %}
                <tr>
                    <td></td>
                    <td>
                        <a target="_blank" href="{% url "admin:household_individual_change" collector.pk %}">
                            {{ collector.individual }}</a>
                    </td>
                    <td>{{ collector.individual.full_name }}</td>
                    <td>{{ collector.role }}</td>
                    <td>
                        <img src="{{ collector.individual.withdrawn|bool_to_icon }}">
                    </td>
                    <td>
                        <img src="{{ collector.individual.duplicate|bool_to_icon }}">
                    </td>
                    <td>{% if collector.household == original %}

                    {% else %}
                        External
                        <a target="_blank" href="{% url "admin:household_household_change" role.household.pk %}">
                            {{ collector.household }}</a>
                    {% endif %}
                    </td>
                </tr>
            {% endfor %}
            <tr>
                <td colspan="3">Tickets</td>
            </tr>
            {% for ticket in tickets %}
                <tr>
                    <td></td>
                    <td><a target="_blank"
                           href="{% url "admin:grievance_grievanceticket_change" ticket.ticket.id %}">{{ ticket.ticket.unicef_id }}</a>
                    </td>
                    <td>{{ ticket.ticket.description }}</td>
                    <td>{{ ticket.ticket.get_issue_type_display }}</td>
                    <td>{{ ticket.ticket.get_status_display }}</td>
                    <td>{{ ticket.ticket.get_category_display }}</td>
                </tr>
            {% endfor %}
        </table>
        {% if allowed %}
            {% csrf_token %}
            <input type="submit"
                   value="{% if original.withdrawn %}Restore{% else %}Withdrawn{% endif %} Household"
                   class="btn btn-default">
        {% endif %}
    </form>
{% endblock action-content %}
