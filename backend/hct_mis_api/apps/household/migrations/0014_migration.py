# Generated by Django 2.2.8 on 2020-07-10 13:12

from django.db import migrations
from django_countries.fields import Country


def to_alpha3(apps, schema_editor):
    Household = apps.get_model("household", "Household")
    DocumentType = apps.get_model("household", "DocumentType")
    ImportedDocumentType = apps.get_model("registration_datahub", "ImportedDocumentType")
    ImportedHousehold = apps.get_model("registration_datahub", "ImportedHousehold")
    for household in Household.objects.all():
        household.country = Country(household.country).alpha3
        household.country_origin = Country(household.country_origin).alpha3
        household.save()
    for household in ImportedHousehold.objects.all():
        household.country = Country(household.country).alpha3
        household.country_origin = Country(household.country_origin).alpha3
        household.save()
    for document_type in DocumentType.objects.all():
        document_type.country = Country(document_type.country).alpha3
        document_type.save()
    for document_type in ImportedDocumentType.objects.all():
        document_type.country = Country(document_type.country).alpha3
        document_type.save()



class Migration(migrations.Migration):
    dependencies = [
        ("household", "0013_migration"),
    ]

    operations = [
        migrations.RunPython(to_alpha3),
        migrations.RunSQL(
            "UPDATE household_household SET unicef_id = format('HH-%s-%s',country ,trim(replace(to_char(unicef_id_index,'0000,0000'),',','.')))"
        ),
        migrations.RunSQL(
            "UPDATE household_individual SET unicef_id = format('IND-%s-%s',TO_CHAR(first_registration_date, 'yy'), trim(replace(to_char(unicef_id_index,'0000,0000'),',','.')))"
        ),
    ]
