# Generated by Django 2.2.8 on 2020-07-10 13:12

from django.db import migrations


def add_unicef_ids_for_old_households(apps, schema_editor):
    Household = apps.get_model("household", "Household")
    households = Household.objects.filter(unicef_id='')
    for household in households:
        household.unicef_id = (
            f"HH-{household.country}-{household.unicef_id_index}"
        )
    Household.objects.bulk_update(households, ("unicef_id",))


def reverse(apps, schema_editor):
    pass


class Migration(migrations.Migration):
    dependencies = [
        ("household", "0011_migration"),
    ]

    operations = [
        migrations.RunSQL(
            """
        CREATE OR REPLACE FUNCTION create_hh_unicef_id() RETURNS trigger
            LANGUAGE plpgsql
            AS $$
        begin
          NEW.unicef_id := format('HH-%s-%s',NEW.country , NEW.unicef_id_index);
          return NEW;
        end
        $$;

        CREATE TRIGGER create_hh_unicef_id BEFORE INSERT ON household_household FOR EACH ROW EXECUTE PROCEDURE create_hh_unicef_id();
        """,
            "",
        ),
        migrations.RunPython(add_unicef_ids_for_old_households, reverse),
    ]
