# Generated by Django 3.2.12 on 2022-03-18 10:05

from django.db import migrations


class Migration(migrations.Migration):

    replaces = [('household', '0012_migration'), ('household', '0013_migration')]

    dependencies = [
        ('household', '0011_migration'),
    ]

    operations = [
        migrations.RunSQL(
            "ALTER TABLE household_household ADD unicef_id_index SERIAL"
        ),
        migrations.RunSQL(
            "ALTER TABLE household_individual ADD unicef_id_index SERIAL"
        ),
        migrations.RunSQL(
            """
        CREATE OR REPLACE FUNCTION create_hh_unicef_id() RETURNS trigger
            LANGUAGE plpgsql
            AS $$
        begin
          NEW.unicef_id := format('HH-%s-%s',TO_CHAR(NEW.first_registration_date, 'yy'), trim(replace(to_char(NEW.unicef_id_index,'0000,0000'),',','.')));
          return NEW;
        end
        $$;

        CREATE TRIGGER create_hh_unicef_id BEFORE INSERT ON household_household FOR EACH ROW EXECUTE PROCEDURE create_hh_unicef_id();
        """,
        ),
        migrations.RunSQL(
            """
        CREATE OR REPLACE FUNCTION create_ii_unicef_id() RETURNS trigger
            LANGUAGE plpgsql
            AS $$
        begin 
          NEW.unicef_id := format('IND-%s-%s',TO_CHAR(NEW.first_registration_date, 'yy'), trim(replace(to_char(NEW.unicef_id_index,'0000,0000'),',','.')));
          return NEW;
        end
        $$;

        CREATE TRIGGER create_ii_unicef_id BEFORE INSERT ON household_individual FOR EACH ROW EXECUTE PROCEDURE create_ii_unicef_id();
        """,
        )
    ]
