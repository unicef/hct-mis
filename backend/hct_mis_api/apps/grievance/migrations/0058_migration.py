# Generated by Django 3.2.18 on 2023-04-12 11:51
from django.contrib.contenttypes.models import ContentType
from django.db import migrations, models
import django.db.models.deletion


def do_ticket_sensitive_migration(apps, schema_editor):
    from hct_mis_api.apps.payment.models import PaymentRecord

    ticket_sensitive_details = apps.get_model("grievance", "TicketSensitiveDetails")
    start = 1_000
    tickets_to_update = []
    i, count = 0, ticket_sensitive_details.objects.all().count() // start + 1

    while i <= count:
        batch = ticket_sensitive_details.objects.all().order_by("created_at")[start * i: start * (i + 1)]
        for ticket in batch:
            payment_record = getattr(ticket, "payment_record", None)
            if payment_record:
                payment_record_id = payment_record.id
                ticket.payment_object_id = payment_record_id
                ticket.payment_content_type_id = ContentType.objects.get_for_model(PaymentRecord).id
                ticket.payment_record_id = None
                tickets_to_update.append(ticket)

        ticket_sensitive_details.objects.bulk_update(
            tickets_to_update,
            ["payment_record_id", "payment_object_id", "payment_content_type_id"]
        )
        tickets_to_update = []
        i += 1


def undo_ticket_sensitive_migration(apps, schema_editor):
    ticket_sensitive_details = apps.get_model("grievance", "TicketSensitiveDetails")
    start = 1_000
    tickets_to_update = []
    i, count = 0, ticket_sensitive_details.objects.all().count() // start + 1

    while i <= count:
        batch = ticket_sensitive_details.objects.all().order_by("created_at")[start * i: start * (i + 1)]
        for ticket in batch:
            ticket.payment_record_id = ticket.payment_object_id
            ticket.payment_object_id = None
            ticket.payment_content_type_id = None
            tickets_to_update.append(ticket)

        ticket_sensitive_details.objects.bulk_update(
            tickets_to_update,
            ["payment_record_id", "payment_object_id", "payment_content_type_id"]
        )
        tickets_to_update = []
        i += 1


class Migration(migrations.Migration):

    dependencies = [
        ('contenttypes', '0002_remove_content_type_name'),
        ('grievance', '0057_migration'),
    ]

    operations = [
        migrations.AddField(
            model_name='ticketsensitivedetails',
            name='payment_content_type',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.CASCADE, to='contenttypes.contenttype'),
        ),
        migrations.AddField(
            model_name='ticketsensitivedetails',
            name='payment_object_id',
            field=models.UUIDField(null=True),
        ),
        migrations.RunPython(do_ticket_sensitive_migration, undo_ticket_sensitive_migration),
        migrations.RemoveField(
            model_name='ticketsensitivedetails',
            name='payment_record',
        ),
    ]
