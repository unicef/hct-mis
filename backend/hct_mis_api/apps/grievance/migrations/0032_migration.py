# Generated by Django 2.2.16 on 2021-08-30 12:07

import django.contrib.postgres.fields.jsonb
from django.db import migrations

from hct_mis_api.apps.grievance.models import GrievanceTicket
from hct_mis_api.apps.household.models import DUPLICATE


def get_deduplication_golden_record(individual):
    status_key = "duplicates" if individual.deduplication_golden_record_status == DUPLICATE else "possible_duplicates"
    return individual.deduplication_golden_record_results.get(status_key, [])


def fill_extra_data(apps, schema_editor):
    TicketNeedsAdjudicationDetails = apps.get_model("grievance", "TicketNeedsAdjudicationDetails")

    db_alias = schema_editor.connection.alias
    tickets = TicketNeedsAdjudicationDetails.objects.using(db_alias).exclude(ticket__status=GrievanceTicket.STATUS_CLOSED)
    for ticket in tickets:
        extra_data = {
            "golden_records": get_deduplication_golden_record(ticket.golden_records_individual),
            "possible_duplicate": get_deduplication_golden_record(ticket.possible_duplicate),
        }
        ticket.extra_data = extra_data

    TicketNeedsAdjudicationDetails.objects.bulk_update(tickets, ["extra_data"])


class Migration(migrations.Migration):

    dependencies = [
        ('grievance', '0031_migration'),
        ('household', '0080_migration'),
    ]

    operations = [
        migrations.AddField(
            model_name='ticketneedsadjudicationdetails',
            name='extra_data',
            field=django.contrib.postgres.fields.jsonb.JSONField(default=dict),
        ),
        migrations.RunPython(fill_extra_data, migrations.RunPython.noop),
    ]
