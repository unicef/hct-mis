{% extends "admin/change_form.html" %}{% load staticfiles %}
{% block content %}
    <table><tr>
    {% for ba in business_ares_permissions %}
        <td><label><input name="{{ ba }}" type="checkbox" value="{{ ba }}" checked>
            {{ ba }}</label></td>
    {% endfor %}
        <td><label><input type="checkbox" value="dj_admin" checked> Admin</label></td>
    </tr></table>

    <input type="text" style="width: 578px;padding:10px;margin-bottom:10px" id="filterInput" placeholder="Search for names..">

    <h1>Roles</h1>
    {% for ba, roles in business_ares_roles.items %}
        <h2 class="section {{ ba }}">{{ ba }}</h2>
        <table id="perm_{{ ba }}">{% for role in roles %}
            <tr>
                <td>{{ role }}</td>
            </tr>
        {% endfor %}</table>
    {% endfor %}

    <h1>Permissions</h1>

    {% for ba, perms in business_ares_permissions.items %}
        <h2 class="section {{ ba }}">{{ ba }}</h2>
        <table id="perm_{{ ba }}">{% for perm in perms %}
            <tr>
                <td>{{ perm }}</td>
            </tr>
        {% endfor %}</table>
    {% endfor %}

    <h2 class="section dj_admin">Admin Permissions</h2>
    <table id="perm_dj_admin">
        {% for perm in permissions %}
            <tr>
                <td>{{ perm.0 }}</td>
                <td>{{ perm.1 }}</td>
            </tr>
        {% endfor %}
    </table>
{% endblock content %}
{% block footer %}
    <script type="text/javascript" src="{% static "admin/js/vendor/jquery/jquery.js" %}"></script>
    <script type="text/javascript" src="{% static "admin/js/jquery.init.js" %}"></script>
    <script>

        function delay(callback, ms) {
            var timer = 0;
            return function () {
                var context = this, args = arguments;
                clearTimeout(timer);
                timer = setTimeout(function () {
                    callback.apply(context, args);
                }, ms || 0);
            };
        }

        (function ($) {
            $('input[type=checkbox]').on('click', function (e) {
                var target_id = $(this).val();
                var $target  = $('table[id="perm_' + target_id +'"]');
                var $title  = $('h2.section.' + target_id);
                if( $(this).is(':checked') ){
                    $target.show();
                    $title.show();
                 } else{
                    $target.hide();
                    $title.hide();
                }
            });

            $('#filterInput').on('keyup', delay(function () {
                let filter = this.value.toUpperCase();
                $('table tr').each(function (i, el) {
                    let txt = $(el).find('td').text();
                    if (txt.toUpperCase().indexOf(filter) > -1) {
                        $(el).closest('.section').show();
                        $(el).show();
                    } else {
                        $(el).hide();
                    }
                    {# $('table').each(function (i, t) {#}
                    {#    if ($(t).find('tr:visible').length === 0) {#}
                    {#        $(t).hide()#}
                    {#    }#}
                    {# }); #}
                });
            }, 300)).trigger('keyup').focus();

        })(django.jQuery)

    </script>
    <div id="footer"></div>{% endblock %}
