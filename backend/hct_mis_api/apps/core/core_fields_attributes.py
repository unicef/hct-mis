from functools import reduce

from core.utils import age_to_birth_date_query
from household.models import RESIDENCE_STATUS_CHOICE, YES_NO_CHOICE

TYPE_INTEGER = "INTEGER"
TYPE_STRING = "STRING"
TYPE_DATE = "DATE"
TYPE_IMAGE = "IMAGE"
TYPE_SELECT_ONE = "SELECT_ONE"
TYPE_SELECT_MANY = "SELECT_MANY"
TYPE_GEOPOINT = "GEOPOINT"
_INDIVIDUAL = "Individual"
_HOUSEHOLD = "Household"

CORE_FIELDS_ATTRIBUTES = [
    {
        "id": "a1741e3c-0e24-4a60-8d2f-463943abaebb",
        "type": TYPE_INTEGER,
        "name": "age",
        "label": {"English(EN)": "Age (calculated)"},
        "hint": "",
        "required": False,
        "get_query": age_to_birth_date_query,
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "age",
    },
    {
        "id": "d6aa9669-ae82-4e3c-adfe-79b5d95d0754",
        "type": TYPE_INTEGER,
        "lookup": "size",
        "name": "Size",
        "label": {"English(EN)": "What is the household size?"},
        "hint": "",
        "required": True,
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "hh_size_hc",
    },
    {
        "id": "3c2473d6-1e81-4025-86c7-e8036dd92f4b",
        "type": TYPE_SELECT_ONE,
        "name": "residence_status",
        "lookup": "residence_status",
        "required": True,
        "label": {"English(EN)": "Residence status"},
        "hint": "",
        "choices": [
            {"label": {"English(EN)": label}, "value": str(value),}
            for value, label in RESIDENCE_STATUS_CHOICE
        ],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "residence_status_h_c",
    },
    {
        "id": "",
        "type": TYPE_SELECT_ONE,
        "name": "consent",
        "lookup": "consent",
        "required": True,
        "label": {"English(EN)": "Do you consent?"},
        "hint": "image of consent",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "consent_h_c",
    },
    {
        "id": "",
        "type": TYPE_SELECT_ONE,
        "name": "country_origin",
        "lookup": "country_origin",
        "required": False,
        "label": {"English(EN)": "Country origin"},
        "hint": "country origin",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "country_origin_h_c",
    },
    {
        "id": "",
        "type": TYPE_SELECT_ONE,
        "name": "country",
        "lookup": "country",
        "required": False,
        "label": {"English(EN)": "Country"},
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "country_h_c",
    },
    {
        "id": "",
        "type": TYPE_STRING,
        "name": "address",
        "lookup": "address",
        "required": False,
        "label": {"English(EN)": "Address"},
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "address_h_c",
    },
    {
        "id": "",
        "type": TYPE_SELECT_ONE,
        "name": "admin1",
        "lookup": "admin1",
        "required": False,
        "label": {
            "English(EN)": "Household resides in (Select administrative level 1)"
        },
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "admin1_h_c",
    },
    {
        "id": "",
        "type": TYPE_SELECT_ONE,
        "name": "admin2",
        "lookup": "admin2",
        "required": False,
        "label": {
            "English(EN)": "Household resides in (Select administrative level 2)"
        },
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "admin2_h_c",
    },
    {
        "id": "",
        "type": TYPE_GEOPOINT,
        "name": "geopoint",
        "lookup": "geopoint",
        "required": False,
        "label": {"English(EN)": "Household Geopoint"},
        "hint": "latitude and longitude of household",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "hh_geopoint_h_c",
    },
    {
        "id": "",
        "type": TYPE_STRING,
        "name": "unhcr_id",
        "lookup": "unhcr_id",
        "required": False,
        "label": {"English(EN)": "UNHCR Case ID"},
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "unhcr_hh_id_h_c",
    },
    {
        "id": "",
        "type": TYPE_SELECT_ONE,
        "name": "returnee",
        "lookup": "returnee",
        "required": False,
        "label": {"English(EN)": "Is this a returnee household?"},
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "returnee_h_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "size",
        "lookup": "size",
        "required": False,
        "label": {"English(EN)": "What is the household size?"},
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "size_h_c",
    },
    {
        "id": "",
        "type": TYPE_SELECT_ONE,
        "name": "relationship",
        "lookup": "relationship",
        "required": True,
        "label": {"English(EN)": "Relationship to Head of Household"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "relationship_i_c",
    },
    {
        "id": "",
        "type": TYPE_SELECT_ONE,
        "name": "role",
        "lookup": "role",
        "required": False,
        "label": {"English(EN)": "Role"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "role_i_c",
    },
    {
        "id": "",
        "type": TYPE_STRING,
        "name": "full_name",
        "lookup": "full_name",
        "required": True,
        "label": {"English(EN)": "Full Name"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "full_name_i_c",
    },
    {
        "id": "",
        "type": TYPE_STRING,
        "name": "given_name",
        "lookup": "given_name",
        "required": False,
        "label": {"English(EN)": "Given Name"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "given_name_i_c",
    },
    {
        "id": "",
        "type": TYPE_STRING,
        "name": "middle_name",
        "lookup": "middle_name",
        "required": False,
        "label": {"English(EN)": "Middle Names"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "middle_name_i_c",
    },
    {
        "id": "",
        "type": TYPE_STRING,
        "name": "family_name",
        "lookup": "family_name",
        "required": False,
        "label": {"English(EN)": "Family Name"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "family_name_i_c",
    },
    {
        "id": "",
        "type": TYPE_SELECT_ONE,
        "name": "sex",
        "lookup": "sex",
        "required": True,
        "label": {"English(EN)": "Sex"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "sex_i_c",
    },
    {
        "id": "",
        "type": TYPE_DATE,
        "name": "birth_date",
        "lookup": "birth_date",
        "required": True,
        "label": {"English(EN)": "Birth Date"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "birth_date_i_c",
    },
    {
        "id": "",
        "type": TYPE_SELECT_ONE,
        "name": "estimated_birth_date",
        "lookup": "estimated_birth_date",
        "required": False,
        "label": {"English(EN)": "Estimated Birth Date?"},
        "hint": "",
        "choices": [
            {"label": {"English(EN)": label}, "value": str(value),}
            for value, label in YES_NO_CHOICE
        ],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "estimated_birth_date_i_c",
    },
    {
        "id": "",
        "type": TYPE_IMAGE,
        "name": "photo",
        "lookup": "photo",
        "required": False,
        "label": {"English(EN)": "Photo"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "photo_i_c",
    },
    {
        "id": "",
        "type": TYPE_SELECT_ONE,
        "name": "marital_status",
        "lookup": "marital_status",
        "required": True,
        "label": {"English(EN)": "Marital Status"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "marital_status_i_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "phone_no",
        "lookup": "phone_no",
        "required": False,
        "label": {"English(EN)": "Phone number"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "phone_no_i_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "phone_no_alternative",
        "lookup": "phone_no_alternative",
        "required": False,
        "label": {"English(EN)": "Alternative phone number"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "phone_no_alternative_i_c",
    },
    {
        "id": "",
        "type": TYPE_SELECT_MANY,
        "name": "id_type",
        "lookup": "id_type",
        "required": False,
        "label": {
            "English(EN)": "What type of identification document is provided?"
        },
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "id_type_i_c",
    },
    {
        "id": "",
        "type": TYPE_STRING,
        "name": "birth_certificate_no",
        "lookup": "birth_certificate_no",
        "required": False,
        "label": {"English(EN)": "Birth certificate number"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "birth_certificate_no_i_c",
    },
    {
        "id": "",
        "type": None,
        "name": "birth_certificate_photo",
        "lookup": "birth_certificate_photo",
        "required": False,
        "label": {"English(EN)": "Birth certificate photo"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "birth_certificate_photo_i_c",
    },
    {
        "id": "",
        "type": TYPE_STRING,
        "name": "drivers_license_no",
        "lookup": "drivers_license_no",
        "required": False,
        "label": {"English(EN)": "Driver's license number"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "drivers_license_no_i_c",
    },
    {
        "id": "",
        "type": None,
        "name": "drivers_license_photo",
        "lookup": "drivers_license_photo",
        "required": False,
        "label": {"English(EN)": "Driver's license photo"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "drivers_license_photo_i_c",
    },
    {
        "id": "",
        "type": TYPE_STRING,
        "name": "electoral_card_no",
        "lookup": "electoral_card_no",
        "required": False,
        "label": {"English(EN)": "Electoral card number"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "electoral_card_no_i_c",
    },
    {
        "id": "",
        "type": None,
        "name": "electoral_card_photo",
        "lookup": "electoral_card_photo",
        "required": False,
        "label": {"English(EN)": "Electoral card photo"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "electoral_card_photo_i_c",
    },
    {
        "id": "",
        "type": TYPE_STRING,
        "name": "unhcr_id_no",
        "lookup": "unhcr_id_no",
        "required": False,
        "label": {"English(EN)": "UNHCR ID number"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "unhcr_id_no_i_c",
    },
    {
        "id": "",
        "type": None,
        "name": "unhcr_id_photo",
        "lookup": "unhcr_id_photo",
        "required": False,
        "label": {"English(EN)": "UNHCR ID photo"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "unhcr_id_photo_i_c",
    },
    {
        "id": "",
        "type": TYPE_STRING,
        "name": "national_passport",
        "lookup": "national_passport",
        "required": False,
        "label": {"English(EN)": "National passport number"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "national_passport_i_c",
    },
    {
        "id": "",
        "type": None,
        "name": "national_passport_photo",
        "lookup": "national_passport_photo",
        "required": False,
        "label": {"English(EN)": "National passport photo"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "national_passport_photo_i_c",
    },
    {
        "id": "",
        "type": TYPE_STRING,
        "name": "scope_id_no",
        "lookup": "scope_id_no",
        "required": False,
        "label": {"English(EN)": "WFP Scope ID number"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "scope_id_no_i_c",
    },
    {
        "id": "",
        "type": None,
        "name": "scope_id_photo",
        "lookup": "scope_id_photo",
        "required": False,
        "label": {"English(EN)": "WFP Scope ID photo"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "scope_id_photo_i_c",
    },
    {
        "id": "",
        "type": TYPE_STRING,
        "name": "other_id_type",
        "lookup": "other_id_type",
        "required": False,
        "label": {"English(EN)": "If other type of ID, specify the type"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "other_id_type_i_c",
    },
    {
        "id": "",
        "type": TYPE_STRING,
        "name": "other_id_no",
        "lookup": "other_id_no",
        "required": False,
        "label": {"English(EN)": "ID number"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "other_id_no_i_c",
    },
    {
        "id": "",
        "type": None,
        "name": "other_id_photo",
        "lookup": "other_id_photo",
        "required": False,
        "label": {"English(EN)": "ID photo"},
        "hint": "",
        "choices": [],
        "associated_with": _INDIVIDUAL,
        "xlsx_field": "other_id_type_i_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "pregnant_member",
        "lookup": "pregnant_member",
        "required": True,
        "label": {
            "English(EN)": "How many pregnant women are there in the Household?"
        },
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "pregnant_member_h_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "female_age_group_0_5_count",
        "lookup": "female_age_group_0_5_count",
        "required": True,
        "label": {
            "Females Age 0-5"
        },
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "f_0_5_age_group_h_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "female_age_group_6_11_count",
        "lookup": "female_age_group_6_11_count",
        "required": True,
        "label": {
            "Females Age 6-11"
        },
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "f_6_11_age_group_h_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "female_age_group_12_17_count",
        "lookup": "female_age_group_12_17_count",
        "required": True,
        "label": {
            "Females Age 12-17"
        },
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "f_12_17_age_group_h_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "female_adults_count",
        "lookup": "female_adults_count",
        "required": True,
        "label": {
            "Female Adults"
        },
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "f_adults_h_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "pregnant_count",
        "lookup": "pregnant_count",
        "required": True,
        "label": {
            "Pregnant females"
        },
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "f_pregnant_h_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "male_age_group_0_5_count",
        "lookup": "male_age_group_0_5_count",
        "required": True,
        "label": {
            "Males Age 0-5"
        },
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "m_0_5_age_group_h_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "male_age_group_6_11_count",
        "lookup": "male_age_group_6_11_count",
        "required": True,
        "label": {
            "Males Age 6-11"
        },
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "m_6_11_age_group_h_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "male_age_group_12_17_count",
        "lookup": "male_age_group_12_17_count",
        "required": True,
        "label": {
            "Males Age 12-17"
        },
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "m_12_17_age_group_h_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "male_adults_count",
        "lookup": "male_adults_count",
        "required": True,
        "label": {
            "Male Adults"
        },
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "m_adults_h_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "female_age_group_0_5_disabled_count",
        "lookup": "female_age_group_0_5_disabled_count",
        "required": True,
        "label": {
            "Female members with Disability age 0-5"
        },
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "f_0_5_disability_h_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "female_age_group_6_11_disabled_count",
        "lookup": "female_age_group_6_11_disabled_count",
        "required": True,
        "label": {
            "Female members with Disability age 6-11"
        },
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "f_6_11_disability_h_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "female_age_group_12_17_disabled_count",
        "lookup": "female_age_group_12_17_disabled_count",
        "required": True,
        "label": {
            "Female members with Disability age 12-17"
        },
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "f_12_17_disability_h_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "female_adults_disabled_count",
        "lookup": "female_adults_disabled_count",
        "required": True,
        "label": {
            "Female members with Disability adults"
        },
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "f_adults_disability_h_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "male_age_group_0_5_disabled_count",
        "lookup": "male_age_group_0_5_disabled_count",
        "required": True,
        "label": {
            "Male members with Disability age 0-5"
        },
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "m_0_5_disability_h_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "male_age_group_6_11_disabled_count",
        "lookup": "male_age_group_6_11_disabled_count",
        "required": True,
        "label": {
            "Male members with Disability age 6-11"
        },
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "m_6_11_disability_h_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "male_age_group_12_17_disabled_count",
        "lookup": "male_age_group_12_17_disabled_count",
        "required": True,
        "label": {
            "Male members with Disability age 12-17"
        },
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "m_12_17_disability_h_c",
    },
    {
        "id": "",
        "type": TYPE_INTEGER,
        "name": "male_adults_disabled_count",
        "lookup": "male_adults_disabled_count",
        "required": True,
        "label": {
            "Male members with Disability adults"
        },
        "hint": "",
        "choices": [],
        "associated_with": _HOUSEHOLD,
        "xlsx_field": "m_adults_disability_h_c",
    },
]


def _reduce_core_field_attr(old, new):
    old[new.get("name")] = new
    return old


def _core_fields_to_separated_dict():
    result_dict = {
        "individuals": {},
        "households": {},
    }
    for field in CORE_FIELDS_ATTRIBUTES:
        associated_key = field["associated_with"].lower() + "s"
        result_dict[associated_key][field["xlsx_field"]] = field

    return result_dict


CORE_FIELDS_ATTRIBUTES_DICTIONARY = reduce(
    _reduce_core_field_attr, CORE_FIELDS_ATTRIBUTES, {}
)

CORE_FIELDS_SEPARATED_WITH_NAME_AS_KEY = _core_fields_to_separated_dict()
