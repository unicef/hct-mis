<!DOCTYPE html>
<html lang="en">
    <head>
        <meta description="hope,hct,dashboard">
        <meta charset="UTF-8">
        <meta keywords="hope,dashboard,unicef">
        <title>Payment Dashboard</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dc/4.2.6/dc.min.js"></script>
        <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
        <link rel="stylesheet"
              href="https://cdnjs.cloudflare.com/ajax/libs/dc/4.2.6/dc.min.css" />
        <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
              rel="stylesheet">
        <style>
        .dc-chart .deselected {
            opacity: 0.3;
        }
        /* Ensure the chart spans the full width and is centered */
        #month-chart {
            width: 100%; /* Full width */
            height: 400px; /* Fixed height */
        }

        /* Make sure the entire page content remains centered */
        .max-w-7xl {
            width: 100%;
            margin: 0 auto;
        }
        </style>
    </head>
    <body class="bg-gray-100">
        <div class="max-w-7xl mx-auto p-4 space-y-8">
            <div class="flex justify-end p-4">
                <label for="business-area-select" class="text-lg font-medium mr-2">Select Business Area:</label>
                <select id="business-area-select" class="border p-2 rounded">
                    <option value="afghanistan"
                            {% if business_area_slug == 'afghanistan' %}selected{% endif %}>Afghanistan</option>
                    <option value="rwanda"
                            {% if business_area_slug == 'rwanda' %}selected{% endif %}>Rwanda</option>
                    <option value="philippines"
                            {% if business_area_slug == 'philippines' %}selected{% endif %}>Philippines</option>
                </select>
            </div>
            <!-- Top Metrics -->
            <div class="bg-white p-4 rounded shadow">
                <h3 class="text-lg font-semibold">Amount Paid per Month and Cumulative Total</h3>
                <div id="month-chart" class="dc-chart"></div>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">Total Amount Paid</h3>
                    <div id="total-amount-paid" class="text-xl font-bold"></div>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">Number of Payments</h3>
                    <div id="number-of-payments" class="text-xl font-bold"></div>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">Outstanding Payment Amounts</h3>
                    <div id="total-local-currency" class="text-xl font-bold"></div>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">Households Reached</h3>
                    <div id="households-reached" class="text-xl font-bold"></div>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">PWD Reached</h3>
                    <div id="pwd-reached" class="text-xl font-bold"></div>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">Children Reached</h3>
                    <div id="children-reached" class="text-xl font-bold"></div>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">Individuals Reached</h3>
                    <div id="individuals-reached" class="text-xl font-bold"></div>
                </div>
            </div>
            <!-- Middle Section (Charts) -->
            <div class="grid grid-cols-3 gap-4">
                <!-- Payments by FSP -->
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">Payments by FSP</h3>
                    <div id="payments-by-fsp" class="dc-chart"></div>
                </div>
                <!-- Payments by Delivery Mechanism -->
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">Payments by Delivery Mechanism</h3>
                    <div id="payments-by-delivery" class="dc-chart"></div>
                </div>
                <!-- Payments by Sector -->
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">Payments by Sector</h3>
                    <div id="payments-by-sector" class="dc-chart"></div>
                </div>
                <!-- Volume by Programme Structure -->
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">Volume by Programme Structure</h3>
                    <div id="volume-by-program" class="dc-chart"></div>
                </div>
            </div>
            <!-- Bottom Section (Verification) -->
            <div class="grid grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded shadow text-center">
                    <h3 class="text-lg font-semibold">Reconciliation</h3>
                    <div class="text-green-500 text-xl font-bold reconciliation-percentage">%</div>
                    <p>Payment records are reconciled</p>
                </div>
                <div class="bg-white p-4 rounded shadow text-center">
                    <h3 class="text-lg font-semibold">Pending Reconciliation</h3>
                    <div class="text-red-500 text-xl font-bold pending-reconciliation-percentage">%</div>
                    <p>Payments pending</p>
                </div>
                <div class="bg-white p-4 rounded shadow text-center">
                    <h3 class="text-lg font-semibold">Verified</h3>
                    <div class="text-green-500 text-xl font-bold">62%</div>
                    <p>Payments verified</p>
                </div>
                <div class="bg-white p-4 rounded shadow text-center">
                    <h3 class="text-lg font-semibold">Sampling Sites Verified</h3>
                    <div class="text-green-500 text-xl font-bold">72%</div>
                    <p>Verification of sampling sites</p>
                </div>
            </div>
        </div>
        <div id="admin1-chart" class="bg-white p-4 rounded shadow"></div>
        <div id="admin2-chart"
             class="bg-white p-4 rounded shadow"
             style="display: none"></div>
        <script>
        function fetchDataForCountry(country) {

        dc.config.defaultColors(d3.schemeTableau10);
        const numberFormatter = d3.format(",.2f");

        function showSpinner(chartId) {
            document.getElementById(chartId).innerHTML = `<div class="spinner-border animate-spin inline-block w-8 h-8 border-4 rounded-full text-blue-500 border-t-transparent"></div>`;
        }

        function hideSpinner(chartId) {
            document.getElementById(chartId).innerHTML = '';
        }
        const selectedCountry = document.getElementById("business-area-select").value || 'afghanistan';

        const url = "{% url 'household-data' business_area_slug='afghanistan' %}".replace('afghanistan', selectedCountry);

        function updateTotals(ndx, successfulPaymentsCount, totalPaymentsCount, pendingPaymentsCount) {
            const totalLocal = ndx.groupAll().reduceSum(d => d.delivered_quantity).value();
            const totalUSD = ndx.groupAll().reduceSum(d => d.delivered_quantity_usd).value();
            const householdsReached = ndx.dimension(d => d.id).group().all().length;
            const individualsReached = ndx.groupAll().reduceSum(d => d.size).value();
            const reconciliationPercentage = (successfulPaymentsCount / totalPaymentsCount) * 100;
            const pendingReconciliationPercentage = (pendingPaymentsCount / totalPaymentsCount) * 100;
            
            // Update the UI
            document.getElementById("total-amount-paid").innerHTML = `${totalUSD.toFixed(2)} USD`;
            document.getElementById("households-reached").innerHTML = `${householdsReached}`; 
            document.getElementById("individuals-reached").innerHTML = `${individualsReached}`; 
            document.getElementById("pwd-reached").innerHTML = `${householdsReached}`;
            document.getElementById("total-local-currency").innerHTML = `${totalLocal.toFixed(2)} AFN`;
            document.querySelector(".reconciliation-percentage").innerHTML = `${reconciliationPercentage.toFixed(2)}%`;
            document.querySelector(".pending-reconciliation-percentage").innerHTML = `${pendingReconciliationPercentage.toFixed(2)}%`;
        }

        function createDashboard() {
            // Set up charts
            const monthChart = dc.compositeChart('#month-chart');
            const fspChart = dc.pieChart('#payments-by-fsp');
            const deliveryChart = dc.pieChart('#payments-by-delivery');
            const sectorChart = dc.rowChart('#payments-by-sector');
            const volumeChart = dc.rowChart('#volume-by-program');
            const admin1Chart = dc.rowChart('#admin1-chart');
            const admin2Chart = dc.rowChart('#admin2-chart');
            
        
            showSpinner('month-chart');
            showSpinner('payments-by-fsp');
            showSpinner('payments-by-delivery');
            showSpinner('payments-by-sector');
            showSpinner('volume-by-program');
            showSpinner('admin1-chart');
        
            d3.json(url).then(function(data) {
                let processedPayments = [];
        
                data.forEach(household => {
                    household.payments.forEach(payment => {
                        processedPayments.push({
                            business_area: household.business_area,
                            delivered_quantity: payment.delivered_quantity ? parseFloat(payment.delivered_quantity) : 0,
                            delivered_quantity_usd: payment.delivered_quantity_usd ? parseFloat(payment.delivered_quantity_usd) : 0,
                            payment_status: payment.status,
                            delivery_date: new Date(payment.delivery_date),
                            year: new Date(payment.delivery_date).getFullYear(),
                            month: new Date(payment.delivery_date).getMonth(),
                            program: household.program,
                            admin1: household.admin1,
                            admin2: household.admin2,
                            sector: household.sector,
                            fsp: payment.fsp,
                            delivery_type: payment.delivery_type,
                            size: household.size,
                            children_count: household.children_count ? household.children_count : 0,
                            id: household.id 
                        });
                    });
                });
        
                processedPayments.sort(function(a, b) {
                    return a.delivery_date - b.delivery_date; 
                });

                const ndx = crossfilter(processedPayments); 
                const monthDim = ndx.dimension(function(d) {
                    return d3.timeMonth(d.delivery_date); 
                });
                const monthlyTotalGroup = monthDim.group().reduceSum(function(d) {
                    return d.delivered_quantity_usd;
                });
                let cumulativeSum = 0;
                const cumulativeGroup = monthDim.group().reduce(
                    function(p, v) { 
                        p.total += v.delivered_quantity_usd;
                        cumulativeSum += v.delivered_quantity_usd; 
                        p.cumulative = cumulativeSum;
                        return p;
                    },
                    function(p, v) { 
                        p.total -= v.delivered_quantity_usd;
                        cumulativeSum -= v.delivered_quantity_usd; 
                        p.cumulative = cumulativeSum;
                        return p;
                    },
                    function() { 
                        return {total: 0, cumulative: 0};
                    }
                );
                // ---- Admin1 and Admin2 Setup ----
                const admin1Dim = ndx.dimension(d => d.admin1);
                const admin1Group = admin1Dim.group();
                
                const admin2Dim = ndx.dimension(d => d.admin2);
                const admin2Group = admin2Dim.group();

                admin1Chart
                    .dimension(admin1Dim)
                    .group(admin1Group)
                    .elasticX(true)
                    .height(2500)
                    .label(function(d) {
                        return `${d.key}: ${d.value}`;
                    })
                    .title(function(d) {
                        return `${d.key}: ${d.value}`;
                    })
                    .on('filtered', function(chart, filter) {
                        if (filter) {
                            admin2Dim.filter(d => admin1Dim.top(Infinity).map(item => item.admin1).includes(d.admin1));
                            admin2Chart.redraw(); 
                            document.getElementById("admin2-chart").style.display = "block";
                        } else {
                            admin2Dim.filterAll();
                            admin2Chart.redraw();
                            document.getElementById("admin2-chart").style.display = "none";
                        }
                    });

                admin2Chart
                    .dimension(admin2Dim)
                    .group(admin2Group)
                    .elasticX(true)
                    .height(300);
                
                document.getElementById("admin2-chart").style.display = "none"; 

                function updateTopMetrics() {
                    const totalPaymentsCount = ndx.groupAll().reduceCount().value();
                    const successfulPaymentsGroup = ndx.groupAll().reduce(
                        (p, v) => {
                            if (["Transaction Successful", "Distribution Successful", "Partially Distributed"].includes(v.payment_status)) {
                                p.count += 1;
                                p.sum += v.delivered_quantity_usd ? parseFloat(v.delivered_quantity_usd) : 0;
                            }
                            return p;
                        },
                        (p, v) => {
                            if (["Transaction Successful", "Distribution Successful", "Partially Distributed"].includes(v.payment_status)) {
                                p.count -= 1;
                                p.sum -= v.delivered_quantity_usd ? parseFloat(v.delivered_quantity_usd) : 0;
                            }
                            return p;
                        },
                        () => ({count: 0, sum: 0})
                    ).value();
                    
                    const totalSuccessfulUSD = successfulPaymentsGroup.sum;
                    const successfulPaymentsCount = successfulPaymentsGroup.count;
                    const pendingPaymentsGroup = ndx.groupAll().reduce(
                        (p, v) => {
                            if (v.payment_status === "Pending") {
                                p.count += 1;
                                p.sum += v.delivered_quantity_usd ? parseFloat(v.delivered_quantity_usd) : 0;
                            }
                            return p;
                        },
                        (p, v) => {
                            if (v.payment_status === "Pending") {
                                p.count -= 1;
                                p.sum -= v.delivered_quantity_usd ? parseFloat(v.delivered_quantity_usd) : 0;
                            }
                            return p;
                        },
                        () => ({count: 0, sum: 0})
                    ).value();
        
                    const totalPendingUSD = pendingPaymentsGroup.sum;
                    const pendingPaymentsCount = pendingPaymentsGroup.count;
                    const householdsReached = ndx.dimension(d => d.id).group().all().length;
                    const childrenReached = ndx.groupAll().reduce(
                        (p, v) => {
                            p += v.children_count ? v.children_count : 0;
                            return p;
                        },
                        (p, v) => {
                            p -= v.children_count ? v.children_count : 0;
                            return p;
                        },
                        () => 0
                    ).value();
        
                    document.getElementById("number-of-payments").innerHTML = `${numberFormatter(successfulPaymentsCount)}`;
                    document.getElementById("total-amount-paid").innerHTML = `${numberFormatter(totalSuccessfulUSD)} USD`;
                    document.getElementById("total-local-currency").innerHTML = `${numberFormatter(totalPendingUSD)} USD`;
                    document.getElementById("households-reached").innerHTML = `${householdsReached}`;
                    document.getElementById("children-reached").innerHTML = `${childrenReached}`; 
                    const reconciliationPercentage = (successfulPaymentsCount / totalPaymentsCount) * 100;
                    const pendingReconciliationPercentage = (pendingPaymentsCount / totalPaymentsCount) * 100;
        
                    document.querySelector(".reconciliation-percentage").innerHTML = `${reconciliationPercentage.toFixed(2)}%`;
                    document.querySelector(".pending-reconciliation-percentage").innerHTML = `${pendingReconciliationPercentage.toFixed(2)}%`;
                }
                const dateExtent = d3.extent(processedPayments, function(d) {
                    return d.delivery_date;
                });
                monthChart
                    .width(window.innerWidth * 0.9)
                    .height(300)
                    .margins({top: 30, right: 100, bottom: 50, left: 50})
                    .x(d3.scaleTime().domain(dateExtent))
                    .brushOn(true)
                    .yAxisLabel('Amount Paid (USD)')
                    .xAxisLabel('Month')
                    .legend(dc.legend().x(100).y(20).itemHeight(13).gap(5))
                    .compose([
                        // Bar chart for total amount paid per month
                        dc.barChart(monthChart)
                            .dimension(monthDim)
                            .group(monthlyTotalGroup, "Total Amount Paid per Month")
                            .centerBar(true) 
                            .gap(5)
                            .colors('purple')
                            .valueAccessor(function(d) { return d.value; })
                            .title(function(d) { 
                                return `Month: ${d.key}\nTotal Paid: ${d3.format(",.2f")(d.value)}`;
                            }),

                        // Line chart for cumulative total paid
                        dc.lineChart(monthChart)
                            .dimension(monthDim)
                            .group(cumulativeGroup, "Cumulative Total Paid")
                            .valueAccessor(function(d) { return d.value.cumulative; })
                            .colors('orange')
                            .curve(d3.curveMonotoneX)
                            .useRightYAxis(true)
                            .renderArea(false)
                            .title(function(d) { 
                                return `Month: ${d.key}\nCumulative Paid: ${d3.format(",.2f")(d.value.cumulative)}`;
                            })
                    ]);

                monthChart.yAxis().ticks(5).tickFormat(d3.format(",.2f")); 
                monthChart.rightYAxis().ticks(5).tickFormat(d3.format(",.2f"));
                monthChart.render();
                        
                const fspDim = ndx.dimension(d => d.fsp);
                const fspGroup = fspDim.group().reduceSum(d => d.delivered_quantity);
                fspChart
                    .dimension(fspDim)
                    .group(fspGroup)
                    .radius(100)
                    .innerRadius(30)
                    .renderLabel(true)
                    .useViewBoxResizing(true)
                    .label(function (d) {
                        const percentage = (d.value / fspGroup.all().reduce((sum, g) => sum + g.value, 0)) * 100;
                        return `${d.key}:  ${percentage.toFixed(0)}%`; 
                    })
                    .title(function (d) {
                        return `${d.key}: ${numberFormatter(d.value)}`;
                    });
        
                const deliveryDim = ndx.dimension(d => d.delivery_type);
                const deliveryGroup = deliveryDim.group().reduceSum(d => d.delivered_quantity);
                deliveryChart
                    .dimension(deliveryDim)
                    .group(deliveryGroup)
                    .radius(100)
                    .innerRadius(30)
                    .renderLabel(true)
                    .useViewBoxResizing(true)
                    .label(function (d) {
                        const percentage = (d.value / deliveryGroup.all().reduce((sum, g) => sum + g.value, 0)) * 100;
                        return `${d.key} ${percentage.toFixed(0)}%`;
                    })
                    .title(function (d) {
                        return `${d.key}: ${numberFormatter(d.value)}`;  
                    });
        
                const sectorDim = ndx.dimension(d => d.sector);
                const sectorGroup = sectorDim.group().reduceSum(d => d.delivered_quantity);
                sectorChart
                    .dimension(sectorDim)
                    .group(sectorGroup)
                    .elasticX(true)
                    .height(300)
                    .label(function(d) {
                        const total = sectorGroup.all().reduce((sum, g) => sum + g.value, 0);
                        const percentage = (d.value / total) * 100;
                        return `${d.key}: ${numberFormatter(d.value)} (${percentage.toFixed(0)}%)`; 
                    })
                    .title(function(d) {
                        return `${d.key}: ${numberFormatter(d.value)}`;
                    })
                    .xAxis().ticks(4); 
        
                const volumeDim = ndx.dimension(d => d.program);
                const volumeGroup = volumeDim.group().reduceSum(d => d.delivered_quantity);
                volumeChart
                    .dimension(volumeDim)
                    .group(volumeGroup)
                    .elasticX(true)  
                    .height(300)
                    .label(function(d) {
                        const total = volumeGroup.all().reduce((sum, g) => sum + g.value, 0);
                        const percentage = (d.value / total) * 100;
                        return `${d.key}: ${numberFormatter(d.value)} (${percentage.toFixed(0)}%)`;
                    })
                    .title(function(d) {
                        return `${d.key}: ${numberFormatter(d.value)}`; 
                    })
                    .xAxis().ticks(4); 
                       
                hideSpinner('payments-by-fsp');
                hideSpinner('payments-by-delivery');
                hideSpinner('payments-by-sector');
                hideSpinner('volume-by-program');
                hideSpinner('month-chart');
                hideSpinner('admin1-chart');
                    
                const dcCharts = [fspChart, deliveryChart, sectorChart, volumeChart, monthChart];
                dcCharts.forEach(chart => {
                    chart.on('filtered', () => {
                        updateTopMetrics();
                        dc.redrawAll();
                    });
                });
        
                dc.renderAll();
        
                updateTopMetrics();
            });
        }
        createDashboard();
        }
        fetchDataForCountry("afghanistan");

        document.getElementById("business-area-select").addEventListener("change", function () {
            const selectedCountry = this.value;
            fetchDataForCountry(selectedCountry);
        });
        </script>
    </body>
</html>
