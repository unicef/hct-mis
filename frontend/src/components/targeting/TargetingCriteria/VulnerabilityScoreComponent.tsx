import {
  Box,
  Button,
  FormControl,
  InputLabel,
  MenuItem,
  Select,
  TextField,
} from '@material-ui/core';
import React, { useState } from 'react';
import { useTranslation } from 'react-i18next';
import styled from 'styled-components';
import { TARGET_POPULATION_QUERY } from '../../../apollo/queries/targeting/TargetPopulation';
import { useBusinessArea } from '../../../hooks/useBusinessArea';
import { useSnackbar } from '../../../hooks/useSnackBar';
import {
  TargetPopulationHouseholdsDocument,
  TargetPopulationQuery,
  TargetPopulationStatus,
  useAllSteficonRulesQuery,
  useSetSteficonRuleOnTargetPopulationMutation,
  useUpdateTpMutation,
} from '../../../__generated__/graphql';
import { AlertDialog } from '../../core/AlertDialog';
import { LoadingComponent } from '../../core/LoadingComponent';

export const ContentWrapper = styled.div`
  display: flex;
  flex-wrap: wrap;
  padding: ${({ theme }) => theme.spacing(4)}px
    ${({ theme }) => theme.spacing(4)}px;
`;
const VulnerabilityScoreDivider = styled.div`
  width: 100%;
  height: 1px;
  background-color: #e0e0e0;
`;
const SelectRow = styled.div`
  display: flex;
  flex-direction: row;
  width: 100%;
  align-items: center;
`;
const CriteriaElement = styled.div`
  width: auto;
  max-width: 380px;
  position: relative;
  border: ${(props) => (props.alternative ? '0' : '2px solid #033f91')};
  border-radius: 3px;
  font-size: 16px;
  background-color: ${(props) =>
    props.alternative ? 'transparent' : '#f7faff'};
  padding: ${({ theme }) => theme.spacing(1)}px
    ${({ theme, alternative }) =>
      alternative ? theme.spacing(1) : theme.spacing(17)}px
    ${({ theme }) => theme.spacing(1)}px ${({ theme }) => theme.spacing(4)}px;
  margin: ${({ theme }) => theme.spacing(2)}px 0;
  p {
    margin: ${({ theme }) => theme.spacing(2)}px 0;
    span {
      color: ${(props) => (props.alternative ? '#000' : '#003c8f')};
      font-weight: bold;
    }
  }
`;
const ButtonMargin = styled(Button)`
  && {
    margin-top: 4px;
    margin-left: ${({ theme }) => theme.spacing(4)}px;
    height: 40px;
  }
`;
const StyledTextField = styled(TextField)`
  input[type='number']::-webkit-inner-spin-button,
  input[type='number']::-webkit-outer-spin-button {
    -webkit-appearance: none;
  }
  input[type='number'] {
    -moz-appearance: textfield;
  }
  && {
    margin: 0 ${({ theme }) => theme.spacing(2)}px;
  }
`;
const ApplyScoreRange = styled.div`
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  margin: ${({ theme }) => theme.spacing(2)}px;
`;

export function VulnerabilityScoreComponent({
  targetPopulation,
}: {
  targetPopulation: TargetPopulationQuery['targetPopulation'];
}): React.ReactElement {
  const { t } = useTranslation();
  const businessArea = useBusinessArea();
  const { showMessage } = useSnackbar();

  const options = {
    refetchQueries: () => [
      {
        query: TARGET_POPULATION_QUERY,
        variables: {
          id: targetPopulation?.id,
        },
      },
      {
        query: TargetPopulationHouseholdsDocument,
        variables: {
          targetPopulation: targetPopulation?.id,
          businessArea,
          first: 10,
          orderBy: null,
        },
      },
    ],
  };
  const [
    setSteficonRule,
    { error },
  ] = useSetSteficonRuleOnTargetPopulationMutation(options);
  const [updateTargetPopulation] = useUpdateTpMutation(options);
  const [vulnerabilityScoreMinValue, setVulnerabilityScoreMinValue] = useState(
    targetPopulation?.vulnerabilityScoreMin?.toString(),
  );
  const [vulnerabilityScoreMaxValue, setVulnerabilityScoreMaxValue] = useState(
    targetPopulation?.vulnerabilityScoreMax?.toString(),
  );
  const [steficonRuleValue, setSteficonRuleValue] = useState<string>(
    targetPopulation?.steficonRule?.rule.id || '',
  );
  const { data, loading } = useAllSteficonRulesQuery({
    variables: { enabled: true, deprecated: false, type: 'TARGETING' },
  });

  if (loading) return <LoadingComponent />;

  if (!targetPopulation || !data) {
    return null;
  }
  const disabled =
    targetPopulation.status === TargetPopulationStatus.ReadyForCashAssist;
  if (
    ![
      TargetPopulationStatus.Locked,
      TargetPopulationStatus.Processing,
      TargetPopulationStatus.SteficonWait,
      TargetPopulationStatus.SteficonRun,
      TargetPopulationStatus.SteficonCompleted,
      TargetPopulationStatus.SteficonError,
      TargetPopulationStatus.ReadyForCashAssist,
    ].includes(targetPopulation?.status)
  ) {
    return null;
  }
  let menuItems = [];
  if (!loading) {
    menuItems = data.allSteficonRules?.edges?.map((item) => {
      return (
        <MenuItem key={item.node.id} value={item.node.id}>
          {item.node.name}
        </MenuItem>
      );
    });
    menuItems.splice(
      0,
      0,
      <MenuItem key='-1' value={null}>
        {t('None')}
      </MenuItem>,
    );
  }
  let criteriaBox = null;
  if (targetPopulation?.steficonRule?.id) {
    criteriaBox = (
      <CriteriaElement>
        <p>{t('Score')}:</p>
        <Box
          display='flex'
          flexDirection='row'
          alignItems='center'
          justifyContent='center'
        >
          {t('From')}{' '}
          <StyledTextField
            variant='outlined'
            type='number'
            value={vulnerabilityScoreMinValue}
            margin='dense'
            disabled={disabled}
            label={t('From')}
            onChange={(event) =>
              setVulnerabilityScoreMinValue(event.target.value)
            }
          />{' '}
          {t('To')}{' '}
          <StyledTextField
            variant='outlined'
            type='number'
            disabled={disabled}
            value={vulnerabilityScoreMaxValue}
            margin='dense'
            label={t('To')}
            onChange={(event) =>
              setVulnerabilityScoreMaxValue(event.target.value)
            }
          />
        </Box>
        <ApplyScoreRange>
          <Button
            variant='contained'
            color='primary'
            disabled={
              (vulnerabilityScoreMinValue ===
                targetPopulation?.vulnerabilityScoreMin?.toString() &&
                vulnerabilityScoreMaxValue ===
                  targetPopulation?.vulnerabilityScoreMax?.toString()) ||
              (vulnerabilityScoreMinValue === '' &&
                vulnerabilityScoreMaxValue !== '') ||
              (vulnerabilityScoreMinValue !== '' &&
                vulnerabilityScoreMaxValue === '') ||
              disabled
            }
            onClick={async () => {
              try {
                await updateTargetPopulation({
                  variables: {
                    input: {
                      id: targetPopulation.id,
                      vulnerabilityScoreMin: vulnerabilityScoreMinValue,
                      vulnerabilityScoreMax: vulnerabilityScoreMaxValue,
                    },
                  },
                });
                showMessage(
                  t('Formula is executing, please wait until completed'),
                );
              } catch (e) {
                e.graphQLErrors.map((x) => showMessage(x.message));
              }
            }}
          >
            {t('Apply')}
          </Button>
        </ApplyScoreRange>
      </CriteriaElement>
    );
  }
  return (
    <>
      <VulnerabilityScoreDivider />
      <ContentWrapper>
        <SelectRow>
          <FormControl variant='outlined' margin='dense' fullWidth>
            <InputLabel>{t('Apply Additional Formula')}</InputLabel>
            <Select
              value={steficonRuleValue}
              disabled={disabled}
              labelWidth={180}
              onChange={(event) =>
                setSteficonRuleValue(event.target.value as string)
              }
            >
              {menuItems}
            </Select>
          </FormControl>
          <ButtonMargin
            variant='contained'
            color='primary'
            disabled={disabled}
            onClick={async () => {
              try {
                await setSteficonRule({
                  variables: {
                    input: {
                      targetId: targetPopulation.id,
                      steficonRuleId: steficonRuleValue,
                    },
                  },
                });
                showMessage(
                  t('Formula is executing, please wait until completed'),
                );
              } catch (e) {
                e.graphQLErrors.map((x) => showMessage(x.message));
              }
            }}
          >
            {t('Apply')}
          </ButtonMargin>
        </SelectRow>
        {criteriaBox}
      </ContentWrapper>
      <AlertDialog message={error?.message} show={!!error} />
    </>
  );
}
